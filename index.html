<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Escape Game</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      color: #333;
      overflow-x: hidden;
      background-color: moccasin;
    }

    #modelCanvas {
      top: 0;
      left: 0;
      width: 100%;
      height: 80%;
      z-index: 0;
      pointer-events: all;
    }

    .bg {
      min-height: 100%;
      display: flex;
      flex-direction: column;
      gap: 2em;
      position: relative;
      z-index: 1;
      background: linear-gradient(moccasin 0%, white 25%);
      align-items: center;
      margin-top: -30vh;
      padding-bottom: 50px;

    }

    .panel {
      background: rgba(255, 255, 255, 1);
      padding: 1.5em 4em;
      border-radius: 12px;
      width: 700px;
    }
    .panel-top {
      position: relative;
      padding: 1.5em 4em 2.5em 4em;
      border-radius: 23px;
      box-shadow: #8c66116e 0px 72px 120px;
    }
    .panel-top::after {
      content: "";
      position: absolute;
      top: -20px;
      left: 20%;
      transform: translateX(-50%) rotate(22deg) scale(2);
      border-width: 0px 25px 50px 35px;
      border-style: solid;
      border-color: transparent transparent white transparent;
      z-index: -1;
    }

    h1 {
      font-size: 2em;
      color: #222;
      text-align: center;
    }

    h2 {
      margin-top: 0;
      color: #444;
    }

    button {
      background: #ffb200;
      border: none;
      color: white;
      font-size: 1em;
      font-weight: bold;
      padding: 0.6em 1.2em;
      margin: 0.5em 0.5em 1em 0;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s ease;
      width: 100%;
    }

    button:hover {
      background: #e09b00;
    }

    .hint {
      display: none;
      margin-bottom: 0.4em;
      padding-left: 1em;
      border-left: 3px solid #ccc;
      color: #333;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
  }

    #fragenContainer {
      display: block;
      padding: 20px;
      /* background: antiquewhite; */
      border: 2px solid antiquewhite;
      border-radius: 8px;
      margin-top: 40px;
    }

    .divider {
      border-bottom: 2px solid #faebd7;
      padding-bottom: 10px;
      margin-bottom: 10px;
    }

    .solution {
      border: 2px solid #ffb200;
      border-radius: 4px;
      background: antiquewhite;
      padding: 8px;
    }

    .vertical-line {
      width: 2px;
      height: 390px;
      background: linear-gradient(360deg, transparent, #0000002e, transparent);
      margin: -200px auto 20px auto;
      z-index: -1;
    }

    .horizontal-line {
      width: 100%;
      height: 2px;
      background: linear-gradient(270deg, transparent, #0000002e, transparent);
      margin: -10px auto;
      max-width: 900px;
    }



    @media only screen and (max-width: 700px) {
      .panel {
          width: 100%;
          padding: 1.5em;
      }
      .bg{
            padding: 0 2.5em;
            padding-bottom: 50px;
      }
      h1 {
        font-size: 1.5em;
      }
    }

</style>
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.178.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.178.0/examples/jsm/"
  }
}
</script>
</head>
<body>
  <canvas id="modelCanvas"></canvas>

  <div class="bg">
    <div class="panel panel-top">
      <h1>Eine Botschaft an euch</h1>
      <audio controls style="width:100%;">
        <source src="assets/audio.mp3" type="audio/mpeg" >
        Your browser does not support the audio element.
      </audio>
    </div>
    
    <div class="vertical-line"></div>
    <h1 style="margin-bottom: -10px;">Tipps</h1>
    <p style="max-width: 700px; text-align: center;">Wenn ihr nicht weiter wisst findet ihr hier hilfreiche Tipps um das Spiel zu lösen,<br> oder falls es garnicht klappt auch die Antwort.
      Viel Spaß!</p>

    <div class="panel">
      <h2>Erstes Rätsel</h2>
      <button onclick="showHint(event, 'r1', 0)">Tipp anzeigen</button>
      <div class="hint" id="r1_0">Schau dir die Muster genau an, findest du sie noch wo anders?</div>
      <div class="hint" id="r1_1">Das Spiralmuster ist ein Punkt, die Schlangenlinie ein Strich. Kannst du damit die geheime Botschaft dekodieren?</div>
      <div class="hint" id="r1_2">Die Muster auf dem Teppich sind ein Morsecode</div>
      <div class="hint solution" id="r1_3"><span>Lösung: Der Code ist • – (A) – • – • (C) • • • • (H) – (T) = 8</span></div>
    </div>

    <div class="horizontal-line"></div>

    <div class="panel">
      <h2>Zweites Rätsel</h2>
      <button onclick="showHint(event, 'r2', 0)">Tipp anzeigen</button>
      <div class="hint" id="r2_0">Der Satz „Wenn man all das zusammenzählt“ ist nicht zufällig hervorgehoben, eine Rechenaufgabe bei der du die versteckten Rechenoperationen im Text finden musst.</div>
      <div class="hint solution" id="r2_1">(((( 2 + 1) - 7 ) + 4 ) / 4 ) + 2 = 2</div>
    </div>

    <div class="horizontal-line"></div>

    <div class="panel">
      <h2>Drittes Rätsel</h2>
      <button onclick="showHint(event, 'r3', 0)">Tipp anzeigen</button>
      <div class="hint" id="r3_0">Verschiedene Fragen scheinen euch hier auf den richtigen Weg zu führen</div>
      <div class="hint" id="r3_1">Achtet auf das Layout der Karte, kommt es euch bekannt vor?</div>
      <div class="hint" id="r3_2">Die Fragen sind mit den Punkten auf der Landkarte verbunden</div>
      <div class="hint" id="r3_3">Verbindet die Punkte miteinander</div>
      <div class="hint solution" id="r3_4">Wenn man die Punkte 5-6-3-2 verbindet ergibt sich die Ziffer 4</div>

      <div id="fragenContainer" style="display: none;">
        <div class="divider">
          <button onclick="showHint(event, 'r4', 0)">Frage 1 - Tipp anzeigen</button>
          <div class="hint" id="r4_0">Es geht wirklich um die Herz-Symbole welche man erkennen kann, nicht abstrakt wie zB. das Herz einer Katze</div>
          <div class="hint" id="r4_1">Es gibt auch Herzen die sich nicht auf dem Würfel befinden</div>
          <div class="hint solution" id="r4_2">2 beim Flugzeug, 1 auf der Wand, 2 auf dem Brief = 5 Herzen</div>
        </div>
        <div class="divider">
          <button onclick="showHint(event, 'r5', 0)">Frage 2 - Lösung anzeigen</button>
          <div class="hint solution" id="r5_0">Es gibt 6 Katzen: Im Cargobike, auf dem Dach, im Baum, auf dem Balkon, auf der Straße, auf der Treppe</div>
        </div>
        <div class="divider">
          <button onclick="showHint(event, 'r6', 0)">Frage 3 - Lösung anzeigen</button>
          <div class="hint solution" id="r6_0">3x, zumindest soweit uns bekannt ist (2x von uns, 1x von Sarah & Benni)</div>
        </div>
        <div>
          <button onclick="showHint(event, 'r7', 0)">Frage 4 - Tipp anzeigen</button>
          <div class="hint" id="r7_0">Vielleicht holt ihr besser die Lupe vom MicroMakro Spiel raus, die Zahl ist sehr klein</div>
          <div class="hint solution" id="r7_1">Es ist Hausnummer 12, also ist die Antwort 2</div>
        </div>
      </div>

    </div>
  </div>
<script type="module">
  import * as THREE from 'three';
  import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
  import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
  import { EXRLoader } from 'three/addons/loaders/EXRLoader.js';

  const canvas = document.getElementById('modelCanvas');

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
  camera.position.set(0, 1, 3);

  const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.shadowMap.enabled = false;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 0.9;

  // ⬇️ Environment: EXR HDRI
  new EXRLoader().load('assets/lakeside_sunrise_1k.exr', function (texture) {
    texture.mapping = THREE.EquirectangularReflectionMapping;
    scene.environment = texture;
    scene.background = null; // oder texture für sichtbaren Hintergrund
  });

  // Licht
  const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1.5);
  hemiLight.position.set(0, 20, 0);
  scene.add(hemiLight);

  const frontLight = new THREE.DirectionalLight(0xffffff, 1.2);
  frontLight.position.set(0, 2, 5);
  frontLight.target.position.set(0, 0, 0);
  scene.add(frontLight);
  scene.add(frontLight.target);

  // Fake Shadow Plane
  const shadowTexture = new THREE.TextureLoader().load('assets/fakeShadow.png');
  const shadowPlane = new THREE.Mesh(
    new THREE.PlaneGeometry(2.5, 2.5),
    new THREE.MeshBasicMaterial({
      map: shadowTexture,
      transparent: true,
      depthWrite: false
    })
  );
  shadowPlane.rotation.x = -Math.PI / 2;
  shadowPlane.position.y = -0.25;
  scene.add(shadowPlane);

  // OrbitControls
  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.enableZoom = false;
  controls.enablePan = false;

  // Model laden
  let model;
  const loader = new GLTFLoader();
  loader.load('assets/model.gltf', function (gltf) {
    model = gltf.scene;
    model.scale.set(0.6, 0.6, 0.6);
    model.position.set(0, 0.7, 0);
    model.rotation.y = 2.5;
    model.rotation.x = 0.25;
 
    model.traverse(obj => {
      if (obj.isMesh) {
        obj.castShadow = false;
        obj.receiveShadow = false;
        if (obj.material && obj.material.envMapIntensity !== undefined) {
          obj.material.envMapIntensity = 1;
          obj.material.needsUpdate = true;
        }
      }
    });
    scene.add(model);
  }, undefined, console.error);

  // Auto-Rotation
  let lastInteraction = Date.now();
  let autoRotate = true;

  function resetIdleTimer() {
    lastInteraction = Date.now();
    autoRotate = false;
  }

  controls.addEventListener('start', resetIdleTimer);
  window.addEventListener('touchstart', resetIdleTimer);
  window.addEventListener('mousedown', resetIdleTimer);

  function animate() {
    requestAnimationFrame(animate);
    if (Date.now() - lastInteraction > 5000) autoRotate = true;
    if (model && autoRotate) model.rotation.y += 0.0015;
    controls.update();
    renderer.render(scene, camera);
  }

  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  animate();
</script>

  <script>
    const currentHintIndex = {
          r1: 0, r2: 0, r3: 0, r4: 0, r5: 0, r6: 0, r7: 0
        };

        function showHint(event, group, index) {
          currentHintIndex[group] = index;
          document.getElementById(`${group}_${index}`).style.display = 'block';

          if (group === 'r3' && index === 0) {
            document.getElementById('fragenContainer').style.display = 'block';
          }

          const next = document.getElementById(`${group}_${index + 1}`);
          const nextNext = document.getElementById(`${group}_${index + 2}`);
          const btn = event.target;

          if (next) {
            btn.textContent = nextNext ? 'Nächster Tipp' : 'Lösung anzeigen';
            btn.setAttribute('onclick', `nextHint('${group}')`);
          } else {
            btn.disabled = true;
          }
        }

        function nextHint(group) {
          const i = ++currentHintIndex[group];
          const hint = document.getElementById(`${group}_${i}`);

          if (hint) {
            hint.style.display = 'block';
            const next = document.getElementById(`${group}_${i + 1}`);
            if (!next) {
              const btn = document.querySelector(`button[onclick="nextHint('${group}')"]`);
              if (btn) btn.disabled = true;
            }
          }
        }


        let lastTouch = 0;
        document.addEventListener('touchend', function(e) {
          const now = new Date().getTime();
          if (now - lastTouch <= 300) {
            e.preventDefault(); // block double-tap zoom
          }
          lastTouch = now;
        }, { passive: false });
  </script>
</body>
</html>