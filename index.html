<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Escape Game</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      color: #333;
      overflow-x: hidden;
      background-color: moccasin;
    }

    #modelCanvas {
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
      pointer-events: all;
    }

    .bg {
      min-height: 100vh;
      padding: 3em 2em;
      display: flex;
      flex-direction: column;
      gap: 2em;
      position: relative;
      z-index: 1;
    }

    .panel {
      background: rgba(255, 255, 255, 0.85);
      padding: 1.5em;
      border-radius: 12px;
      max-width: 700px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    h1 {
      font-size: 2em;
      color: #222;
    }

    h2 {
      margin-top: 0;
      color: #444;
    }

    button {
      background: #ffb200;
      border: none;
      color: white;
      font-size: 1em;
      font-weight: bold;
      padding: 0.6em 1.2em;
      margin: 0.5em 0.5em 1em 0;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s ease;
      width: 100%;
    }

    button:hover {
      background: #e09b00;
    }

    .hint {
      display: none;
      margin-bottom: 0.4em;
      padding-left: 1em;
      border-left: 3px solid #ccc;
      color: #333;
    }

    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
  </style>
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.178.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.178.0/examples/jsm/"
  }
}
</script>
</head>
<body>
  <canvas id="modelCanvas"></canvas>

  <div class="bg">
    <div class="panel">
      <h1>Escape Game</h1>
      <audio id="audio" src="audio.mp3"></audio>
      <button id="playBtn">▶️ Audio abspielen</button>
    </div>

    <div class="panel">
      <h2>Erstes Rätsel</h2>
      <button onclick="showHint('r1', 0)">Hinweis anzeigen</button>
      <div class="hint" id="r1_0">1. Schau dir die Muster genau an, findest du sie noch wo anders?</div>
      <div class="hint" id="r1_1">2. Das Spiralmuster ist ein Punkt, die Schlangenlinie ein Strich. Kannst du damit die geheime Botschaft dekodieren?</div>
      <div class="hint" id="r1_2">3. Die Muster auf dem Teppich sind ein Morsecode</div>
      <div class="hint" id="r1_3">4. Der Code ist • - (A) - • - • (C) • • • • (H) - (T) = 8</div>
    </div>

    <div class="panel">
      <h2>Zweites Rätsel</h2>
      <button onclick="showHint('r2', 0)">Hinweis anzeigen</button>
      <div class="hint" id="r2_0">1. Der Satz „Wenn man all das zusammenzählt“ ist nicht zufällig hervorgehoben, eine Rechenaufgabe bei der du die versteckten Rechenoperationen im Text finden musst.</div>
      <div class="hint" id="r2_1">2. (((( 2 + 1) - 7 ) + 4 ) / 4 ) + 2 = 2</div>
    </div>

    <div class="panel">
      <h2>Drittes Rätsel</h2>
      <button onclick="showHint('r3', 0)">Hinweis anzeigen</button>
      <div class="hint" id="r3_0">a1. Es gibt auch Herzen die sich nicht auf dem Würfel befinden</div>
      <div class="hint" id="r3_1">a2. 5</div>
      <div class="hint" id="r3_2">b. 6</div>
      <div class="hint" id="r3_3">c. 3</div>
      <div class="hint" id="r3_4">d. 2</div>
    </div>
  </div>
<script type="module">
  import * as THREE from 'three';
  import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
  import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
  import { EXRLoader } from 'three/addons/loaders/EXRLoader.js';

  const canvas = document.getElementById('modelCanvas');

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
  camera.position.set(0, 1, 3);

  const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.shadowMap.enabled = false;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 0.9;

  // ⬇️ Environment: EXR HDRI
  new EXRLoader().load('assets/lakeside_sunrise_1k.exr', function (texture) {
    texture.mapping = THREE.EquirectangularReflectionMapping;
    scene.environment = texture;
    scene.background = null; // oder texture für sichtbaren Hintergrund
  });

  // Licht
  const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1.5);
  hemiLight.position.set(0, 20, 0);
  scene.add(hemiLight);

  const frontLight = new THREE.DirectionalLight(0xffffff, 1.2);
  frontLight.position.set(0, 2, 5);
  frontLight.target.position.set(0, 0, 0);
  scene.add(frontLight);
  scene.add(frontLight.target);

  // Fake Shadow Plane
  const shadowTexture = new THREE.TextureLoader().load('assets/fakeShadow.png');
  const shadowPlane = new THREE.Mesh(
    new THREE.PlaneGeometry(2.5, 2.5),
    new THREE.MeshBasicMaterial({
      map: shadowTexture,
      transparent: true,
      depthWrite: false
    })
  );
  shadowPlane.rotation.x = -Math.PI / 2;
  shadowPlane.position.y = -1;
  scene.add(shadowPlane);

  // OrbitControls
  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.enableZoom = false;
  controls.enablePan = false;

  // Model laden
  let model;
  const loader = new GLTFLoader();
  loader.load('assets/model.gltf', function (gltf) {
    model = gltf.scene;
    model.scale.set(0.6, 0.6, 0.6);
    model.position.set(0, 0.2, 0);
    model.traverse(obj => {
      if (obj.isMesh) {
        obj.castShadow = false;
        obj.receiveShadow = false;
        if (obj.material && obj.material.envMapIntensity !== undefined) {
          obj.material.envMapIntensity = 1;
          obj.material.needsUpdate = true;
        }
      }
    });
    scene.add(model);
  }, undefined, console.error);

  // Auto-Rotation
  let lastInteraction = Date.now();
  let autoRotate = true;

  function resetIdleTimer() {
    lastInteraction = Date.now();
    autoRotate = false;
  }

  controls.addEventListener('start', resetIdleTimer);
  window.addEventListener('touchstart', resetIdleTimer);
  window.addEventListener('mousedown', resetIdleTimer);

  function animate() {
    requestAnimationFrame(animate);
    if (Date.now() - lastInteraction > 5000) autoRotate = true;
    if (model && autoRotate) model.rotation.y += 0.0015;
    controls.update();
    renderer.render(scene, camera);
  }

  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  animate();
</script>

  <script>
    // Audio + Hint System bleibt als normales Script
    document.getElementById('playBtn').addEventListener('click', () => {
      const audio = document.getElementById('audio');
      audio.play();
    });

    const currentHintIndex = {
      r1: 0,
      r2: 0,
      r3: 0
    };

    function showHint(group, index) {
        currentHintIndex[group] = index;
        document.getElementById(`${group}_${index}`).style.display = 'block';

        const next = document.getElementById(`${group}_${index + 1}`);
        const btn = document.querySelector(`button[onclick="showHint('${group}', 0)"]`);
        if (next) {
            btn.textContent = 'Nächster Hinweis';
            btn.setAttribute('onclick', `nextHint('${group}')`);
        } else {
            btn.disabled = true;
        }
    }

    function nextHint(group) {
      const i = ++currentHintIndex[group];
      const hint = document.getElementById(`${group}_${i}`);

      if (hint) {
          hint.style.display = 'block';
          const next = document.getElementById(`${group}_${i + 1}`);
          if (!next) {
              const btn = document.querySelector(`button[onclick="nextHint('${group}')"]`);
              if (btn) btn.disabled = true;
          }
      }
    }
  </script>
</body>
</html>